import{a as ge,b as pe,d as je,r as t,u as Z,j as e,L as ye,C as be,T as d,B as r,g as Q,P as C,z as De,F as we,I as U,f as R}from"./index-7eb3e469.js";import{F as Ie,I as Se}from"./OutlinedInput-42254326.js";import{S as Ce}from"./Select-237f65fb.js";import{P as Re,a as Te,V as Le,b as ke,c as Ve,S as Ee}from"./VolumeUp-d05546db.js";import{C as Me}from"./Chip-09e1a2f1.js";import{A as Pe}from"./Alert-3907e571.js";import{R as Y}from"./Refresh-becb9bf5.js";import{A as q}from"./Add-37124aba.js";import{D as Ae}from"./DevicesOther-e91b7011.js";const Ze=()=>{const J=ge(),K=pe(),i=je(K.breakpoints.down("sm")),[f,y]=t.useState(!1),[a,T]=t.useState([]),[c,L]=t.useState(0),[A,b]=t.useState(!0),[X,v]=t.useState(null),[p,F]=t.useState(!1),[_,k]=t.useState(!0),[V,ee]=t.useState(1),[u,B]=t.useState(""),[te,D]=t.useState("Checking live status..."),{GetRegisterdDevices:se}=Z(),[N,E]=t.useState([]),[M,z]=t.useState(!0),[ne,W]=t.useState(!1),{checkLiveStatus:re,getFilteredVideos:ie}=Z(),l=t.useRef(null),j=t.useRef(null),m=t.useRef(null),h=t.useRef(null),P=new Date().toLocaleDateString("en-GB").replace(/\//g,"-"),oe="01:00:00",$=()=>{const s=new Date,n=s.toTimeString().slice(0,8),x=new Date(s.getTime()-2*60*1e3).toTimeString().slice(0,8);return{currentTime:n,twoMinutesAgoTime:x}},O=()=>{J("/settings")},H=async()=>{var s;z(!0),W(!1);try{const n=await se();if(((s=n==null?void 0:n.devices)==null?void 0:s.length)>0){const o=n.devices.map(g=>({value:g.deviceName,label:g.nickname||g.deviceName,code:g.deviceCode}));E(o);const x=o[0].value;B(x),localStorage.setItem("Device",x)}else W(!0),E([]),b(!1)}catch(n){console.error("Error fetching registered devices:",n),v("Failed to fetch registered devices. Please try again later."),E([]),b(!1)}finally{z(!1)}},w=async()=>{D("Checking live status...");const{currentTime:s,twoMinutesAgoTime:n}=$();try{(await re(P,n,s,u)).isLive?(y(!0),D("Device is live"),I()):(y(!1),D("Device is offline"),v("Device is not currently transmitting live data."))}catch(o){y(!1),v(`Error checking live status: ${o.message}`),D("Connection error")}finally{b(!1)}},I=async()=>{if(!u)return;const{currentTime:s}=$(),n={fromDate:P,toDate:P,fromTime:oe,toTime:s,selectedDevice:u};try{const o=await ie(n);if(o&&o.length>0){const x=o.sort((me,he)=>{const xe=new Date(`1970-01-01T${me.fromtime}Z`).getTime(),ve=new Date(`1970-01-01T${he.fromtime}Z`).getTime();return xe-ve});T(x);const g=x.length-1;L(g),v(null)}else v("No videos found for today."),T([])}catch(o){v(`Error fetching videos: ${o.message}`)}},ae=()=>{c<a.length-1?L(c+1):I()},G=()=>{!l.current||a.length===0||(p?l.current.pause():l.current.play(),F(!p),S())},ce=(s,n)=>{ee(n),l.current&&(l.current.volume=n),S()},S=()=>{k(!0),j.current&&clearTimeout(j.current),j.current=setTimeout(()=>{p&&k(!1)},3e3)},le=()=>{S()},de=()=>{S()},ue=s=>{const n=s.target.value;B(n),b(!0),y(!1),T([]),L(0),w()};t.useEffect(()=>(H(),()=>{h.current&&clearInterval(h.current),m.current&&clearInterval(m.current),j.current&&clearTimeout(j.current)}),[]),t.useEffect(()=>(u&&!M&&(w(),h.current&&clearInterval(h.current),m.current&&clearInterval(m.current),h.current=setInterval(()=>{w()},6e4),m.current=setInterval(()=>{f&&I()},2e4),localStorage.setItem("Device",u)),()=>{h.current&&clearInterval(h.current),m.current&&clearInterval(m.current)}),[u,M]),t.useEffect(()=>{if(a.length>0&&c>=0&&c<a.length){const s=a[c];l.current&&s&&(l.current.src=s.url,f&&l.current.play().then(()=>F(!0)).catch(n=>console.error("Error playing video:",n)))}},[a,c]),t.useEffect(()=>{f&&I()},[f]);const fe=()=>e.jsxs(r,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:5,minHeight:400,textAlign:"center"},children:[e.jsx(Ae,{sx:{fontSize:80,color:"text.secondary",mb:3}}),e.jsx(d,{variant:"h5",gutterBottom:!0,children:"No Devices Registered"}),e.jsx(d,{variant:"body1",color:"text.secondary",paragraph:!0,children:"You don't have any registered devices, ManojGowda89. Register a device to start monitoring live video surveillance."}),e.jsx(R,{variant:"contained",color:"primary",startIcon:e.jsx(q,{}),size:"large",onClick:O,sx:{mt:2},children:"Register New Device"}),e.jsx(R,{variant:"outlined",onClick:H,startIcon:e.jsx(Y,{}),sx:{mt:2},children:"Refresh"})]});return e.jsx(ye,{title:"Dmarg - Live Surveillance",children:e.jsxs(be,{maxWidth:"xl",sx:{py:4},children:[e.jsx(d,{variant:"h4",component:"h1",align:"center",gutterBottom:!0,sx:{borderBottom:"2px solid #1976d2",pb:1,mb:3},children:"Live Video Surveillance"}),M?e.jsxs(r,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"50vh"},children:[e.jsx(Q,{size:60}),e.jsx(d,{variant:"h6",sx:{mt:3},children:"Loading devices..."})]}):ne?e.jsx(C,{elevation:3,sx:{borderRadius:2,overflow:"hidden"},children:e.jsx(fe,{})}):e.jsxs(e.Fragment,{children:[e.jsxs(C,{elevation:2,sx:{p:2,mb:3,borderRadius:2,display:"flex",flexDirection:i?"column":"row",justifyContent:"space-between",alignItems:i?"flex-start":"center",gap:2},children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1,flexWrap:"wrap"},children:[e.jsx(d,{variant:"h6",component:"h2",sx:{my:0},children:"Live Surveillance"}),e.jsx(r,{component:"span",sx:{display:"inline-block",width:12,height:12,borderRadius:"50%",bgcolor:f?"success.main":"error.main",ml:1}}),e.jsx(d,{variant:"body2",color:"text.secondary",children:te})]}),e.jsxs(Ie,{variant:"outlined",size:i?"medium":"small",sx:{minWidth:i?"100%":220},children:[e.jsx(Se,{id:"device-select-label",children:"Select Device"}),e.jsx(Ce,{labelId:"device-select-label",id:"device-select",value:u,onChange:ue,label:"Select Device",disabled:A||N.length===0,children:N.map(s=>e.jsxs(De,{value:s.value,children:[s.label," (",s.value,")"]},s.value))})]})]}),A?e.jsxs(r,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"50vh",p:4,bgcolor:"background.paper",borderRadius:2},children:[e.jsx(Q,{size:60}),e.jsx(d,{variant:"h6",sx:{mt:3},children:"Connecting to device..."})]}):e.jsx(C,{elevation:3,sx:{borderRadius:2,overflow:"hidden",bgcolor:"#000",mb:2},children:f?e.jsxs(r,{sx:{position:"relative",width:"100%",aspectRatio:"16/9"},onMouseMove:le,onTouchStart:de,onMouseLeave:()=>p&&k(!1),children:[e.jsx(r,{component:"video",ref:l,sx:{width:"100%",height:"100%",objectFit:"contain"},onClick:G,onEnded:ae,preload:"auto",playsInline:!0}),e.jsx(we,{in:_,children:e.jsxs(r,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",display:"flex",flexDirection:"column",justifyContent:"space-between",p:i?1.5:2,background:"linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 30%, rgba(0,0,0,0) 70%, rgba(0,0,0,0.7) 100%)"},children:[e.jsx(r,{children:a[c]&&e.jsx(d,{variant:i?"body2":"body1",sx:{color:"#fff",fontWeight:"bold",textShadow:"1px 1px 2px rgba(0,0,0,0.8)"},children:a[c].filename})}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",width:"100%"},children:[e.jsx(U,{onClick:G,color:"primary",sx:{bgcolor:"rgba(0,0,0,0.5)","&:hover":{bgcolor:"rgba(0,0,0,0.7)"},color:"#fff",width:i?48:40,height:i?48:40},children:p?e.jsx(Re,{}):e.jsx(Te,{})}),!i&&e.jsxs(r,{sx:{display:"flex",alignItems:"center",width:120,mx:2},children:[e.jsx(U,{sx:{color:"#fff"},children:V===0?e.jsx(Le,{}):V<.5?e.jsx(ke,{}):e.jsx(Ve,{})}),e.jsx(Ee,{value:V,min:0,max:1,step:.1,onChange:ce,"aria-labelledby":"volume-slider",sx:{color:"#fff","& .MuiSlider-thumb":{width:12,height:12}}})]}),e.jsx(Me,{label:"LIVE",color:"error",size:i?"medium":"small",sx:{animation:"pulse 1.5s infinite","@keyframes pulse":{"0%":{opacity:1},"50%":{opacity:.7},"100%":{opacity:1}},fontWeight:"bold"}})]})]})})]}):e.jsxs(r,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",p:5,bgcolor:"background.paper",minHeight:300},children:[e.jsx(r,{component:"img",src:"/notlive.gif",alt:"Device Offline",sx:{maxWidth:i?150:200,mb:3}}),e.jsx(Pe,{severity:"info",sx:{mb:3,width:"100%",maxWidth:500},children:X||"Device is currently offline"}),e.jsx(R,{variant:"contained",startIcon:e.jsx(Y,{}),onClick:w,sx:{minWidth:i?240:200},children:"Retry Connection"})]})}),f&&a.length>0&&e.jsx(C,{elevation:1,sx:{p:2,borderRadius:2},children:e.jsxs(d,{variant:"body2",color:"text.secondary",align:"center",children:["Streaming live footage from ",u,".",a.length>0&&` Currently showing video #${c+1} of ${a.length}.`]})}),e.jsx(r,{sx:{display:"flex",justifyContent:"flex-end",mt:2},children:e.jsx(R,{variant:"outlined",size:"small",startIcon:e.jsx(q,{}),onClick:O,children:"Register New Device"})})]})]})})};export{Ze as default};
